(()=>{var e={};e.id=374,e.ids=[374],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34972:(e,t,n)=>{"use strict";n.r(t),n.d(t,{patchFetch:()=>w,routeModule:()=>b,serverHooks:()=>y,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>z});var r={};n.r(r),n.d(r,{GET:()=>g,POST:()=>v,dynamic:()=>m});var i=n(54899),s=n(85420),a=n(22403),o=n(44917),u=n(62686),l=n(62258),c=n(46022),d=n(44069),p=n(96330);let m="force-dynamic";async function g(e){try{let e,t=await (0,l.oC)();e=t.role===p.Role.SUPER_ADMIN?await u.z.venue.findMany({include:{owner:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},_count:{select:{bookings:!0,tables:!0}}},orderBy:{createdAt:"desc"}}):await u.z.venue.findMany({where:{ownerId:t.id},include:{_count:{select:{bookings:!0,tables:!0}}},orderBy:{createdAt:"desc"}});let n=Array.isArray(e)?e:[];return o.NextResponse.json({success:!0,venues:n})}catch(e){if(console.error("Get venues error:",e),"Authentication required"===e.message)return o.NextResponse.json({error:"Authentication required",venues:[]},{status:401});if("Account is inactive"===e.message)return o.NextResponse.json({error:"Account is inactive",venues:[]},{status:403});if("Insufficient permissions"===e.message)return o.NextResponse.json({error:"Insufficient permissions",venues:[]},{status:403});return o.NextResponse.json({error:"Failed to fetch venues",venues:[]},{status:500})}}async function v(e){try{let t,n=await (0,l.oC)([p.Role.VENUE_OWNER,p.Role.SUPER_ADMIN]);if(n.role!==p.Role.SUPER_ADMIN){let e=await (0,d.jI)(n.id);if(!e.canCreateVenue)return o.NextResponse.json({error:"Venue limit reached",message:e.message,plan:e.plan,venuesUsed:e.venuesUsed,venuesLimit:e.venuesLimit},{status:403})}try{t=await e.json()}catch(e){return o.NextResponse.json({error:"Invalid JSON format"},{status:400})}let r=c.nu.parse(t),i=r.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");if(await u.z.venue.findUnique({where:{slug:i}}))return o.NextResponse.json({error:"A venue with this name already exists"},{status:409});let s=await u.z.venue.create({data:{...r,slug:i,ownerId:n.id,subscription:{create:{plan:p.SubscriptionPlan.STARTER,status:p.SubscriptionStatus.ACTIVE,currentPeriodStart:new Date,currentPeriodEnd:new Date(Date.now()+2592e6),bookingsLimit:50}}},include:{}});return o.NextResponse.json({success:!0,venue:s})}catch(e){if(console.error("Create venue error:",e),"Authentication required"===e.message)return o.NextResponse.json({error:"Authentication required"},{status:401});if("Account is inactive"===e.message)return o.NextResponse.json({error:"Account is inactive"},{status:403});if("Insufficient permissions"===e.message)return o.NextResponse.json({error:"Insufficient permissions"},{status:403});if("ZodError"===e.name)return o.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});if("P2002"===e.code)return o.NextResponse.json({error:"A venue with this information already exists"},{status:409});return o.NextResponse.json({error:"Failed to create venue"},{status:500})}}let b=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/venues/route",pathname:"/api/venues",filename:"route",bundlePath:"app/api/venues/route"},resolvedPagePath:"/home/ubuntu/sully-booking-system-production/app/app/api/venues/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:f,workUnitAsyncStorage:z,serverHooks:y}=b;function w(){return(0,a.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:z})}},43331:()=>{},44069:(e,t,n)=>{"use strict";n.d(t,{ZT:()=>c,dL:()=>a,gJ:()=>o,jI:()=>l,k:()=>s});var r=n(62686),i=n(96330);async function s(e){let t=await r.z.subscription.findUnique({where:{venueId:e}});return t?{canCreateBooking:t.plan===i.SubscriptionPlan.PROFESSIONAL||t.plan===i.SubscriptionPlan.ENTERPRISE||null!==t.bookingsLimit&&t.bookingsUsed<t.bookingsLimit,bookingsUsed:t.bookingsUsed,bookingsLimit:t.bookingsLimit,plan:t.plan}:(await r.z.subscription.create({data:{venueId:e,plan:i.SubscriptionPlan.STARTER,status:i.SubscriptionStatus.ACTIVE,currentPeriodStart:new Date,currentPeriodEnd:new Date(Date.now()+2592e6),bookingsLimit:50}}),{canCreateBooking:!0,bookingsUsed:0,bookingsLimit:50,plan:i.SubscriptionPlan.STARTER})}async function a(e){let t=await r.z.subscription.findUnique({where:{venueId:e}}),n=t?.plan||i.SubscriptionPlan.STARTER;return{canUploadLogo:!0,canUploadHeader:!0,canUploadGallery:n===i.SubscriptionPlan.ENTERPRISE||n===i.SubscriptionPlan.PROFESSIONAL,maxGalleryImages:20*(n===i.SubscriptionPlan.ENTERPRISE||n===i.SubscriptionPlan.PROFESSIONAL),plan:n}}async function o(e){await r.z.subscription.update({where:{venueId:e},data:{bookingsUsed:{increment:1}}})}let u={FREE:{venues:1,bookingsPerMonth:50,galleryImages:0,analytics:!0,widgets:!0,customBranding:!1,prioritySupport:!1},PAID:{venues:5,bookingsPerMonth:null,galleryImages:20,analytics:!0,widgets:!0,customBranding:!0,prioritySupport:!1},PREMIUM:{venues:null,bookingsPerMonth:null,galleryImages:20,analytics:!0,widgets:!0,customBranding:!0,prioritySupport:!0}};async function l(e){let t,n=await r.z.venue.count({where:{ownerId:e}}),s=await r.z.venue.findMany({where:{ownerId:e},include:{subscription:!0}}),a=i.SubscriptionPlan.STARTER;for(let e of s)if(e.subscription)if(e.subscription.plan===i.SubscriptionPlan.ENTERPRISE){a=i.SubscriptionPlan.ENTERPRISE;break}else e.subscription.plan===i.SubscriptionPlan.PROFESSIONAL&&a===i.SubscriptionPlan.STARTER&&(a=i.SubscriptionPlan.PROFESSIONAL);let o=u[a],l=null===o.venues||n<o.venues;return l||(t=`You've reached the venue limit for your ${a} plan (${o.venues} venue${1===o.venues?"":"s"}). Upgrade to create more venues.`),{canCreateVenue:l,venuesUsed:n,venuesLimit:o.venues,plan:a,message:t}}async function c(e){let t=await l(e),n=u[t.plan];return{plan:t.plan,venues:{used:t.venuesUsed,limit:t.venuesLimit},features:{bookingsPerMonth:n.bookingsPerMonth,galleryImages:n.galleryImages,analytics:n.analytics,widgets:n.widgets,customBranding:n.customBranding,prioritySupport:n.prioritySupport}}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46022:(e,t,n)=>{"use strict";n.d(t,{Au:()=>m,FZ:()=>u,Si:()=>p,X5:()=>s,Zq:()=>c,_A:()=>l,nu:()=>o,zK:()=>a});var r=n(66146),i=n(96330);let s=r.z.object({email:r.z.string().email("Invalid email address"),password:r.z.string().min(6,"Password must be at least 6 characters")}),a=r.z.object({email:r.z.string().email("Invalid email address"),password:r.z.string().min(6,"Password must be at least 6 characters"),firstName:r.z.string().min(1,"First name is required"),lastName:r.z.string().min(1,"Last name is required"),phone:r.z.string().optional()}),o=r.z.object({name:r.z.string().min(1,"Venue name is required"),description:r.z.string().optional(),address:r.z.string().min(1,"Address is required"),city:r.z.string().min(1,"City is required"),postcode:r.z.string().min(1,"Postcode is required"),phone:r.z.string().min(1,"Phone is required"),email:r.z.string().email("Invalid email address"),website:r.z.string().url().optional().or(r.z.literal("")),cuisine:r.z.string().optional(),venueType:r.z.nativeEnum(i.VenueType),capacity:r.z.number().min(1,"Capacity must be at least 1")}),u=r.z.object({venueId:r.z.string().min(1,"Venue is required"),serviceType:r.z.nativeEnum(i.ServiceType),date:r.z.string().min(1,"Date is required"),time:r.z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Invalid time format"),partySize:r.z.number().min(1,"Party size must be at least 1"),customerName:r.z.string().min(1,"Customer name is required"),customerEmail:r.z.string().email("Invalid email address"),customerPhone:r.z.string().min(1,"Phone number is required"),specialRequests:r.z.string().optional(),tableId:r.z.string().optional()}),l=r.z.object({name:r.z.string().min(1,"Table name is required"),capacity:r.z.number().min(1,"Capacity must be at least 1"),description:r.z.string().optional()});r.z.object({name:r.z.string().min(1,"Event name is required"),description:r.z.string().optional(),date:r.z.string().min(1,"Date is required"),startTime:r.z.string().min(1,"Start time is required"),endTime:r.z.string().min(1,"End time is required"),capacity:r.z.number().min(1,"Capacity must be at least 1"),price:r.z.number().min(0,"Price must be positive").optional()});let c=r.z.object({dayOfWeek:r.z.number().min(0).max(6),openTime:r.z.string().min(1,"Open time is required"),closeTime:r.z.string().min(1,"Close time is required"),isOpen:r.z.boolean()}),d=r.z.object({dayOfWeek:r.z.number().min(0).max(6),openTime:r.z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Invalid time format"),closeTime:r.z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Invalid time format"),name:r.z.string().optional(),isActive:r.z.boolean().default(!0)}),p=r.z.object({openingHours:r.z.array(d)}),m=r.z.object({name:r.z.string().min(1,"Widget name is required"),settings:r.z.object({theme:r.z.string().optional(),primaryColor:r.z.string().optional(),showLogo:r.z.boolean().optional(),allowedServices:r.z.array(r.z.nativeEnum(i.ServiceType)).optional()}).optional()})},55511:e=>{"use strict";e.exports=require("crypto")},62258:(e,t,n)=>{"use strict";n.d(t,{BE:()=>d,Er:()=>c,Ht:()=>m,jw:()=>p,l4:()=>v,oC:()=>g});var r=n(29657),i=n.n(r),s=n(3197),a=n.n(s),o=n(24883),u=n(62686);let l=process.env.JWT_SECRET||"sully-booking-system-secret-key";async function c(e){return i().hash(e,12)}async function d(e,t){return i().compare(e,t)}async function p(e){var t;let n=(t={userId:e},a().sign(t,l,{expiresIn:"7d"})),r=new Date;return r.setDate(r.getDate()+7),await u.z.userSession.create({data:{userId:e,token:n,expiresAt:r}}),n}async function m(){console.log("\uD83D\uDD35 [AUTH-LIB] Getting session");try{let e=(0,o.UL)(),t=e.get("auth-token")?.value;if(console.log("\uD83D\uDD35 [AUTH-LIB] Token from cookies:",t?`Token found (${t.substring(0,20)}...)`:"No token found"),!t)return console.log("\uD83D\uDD35 [AUTH-LIB] No auth token found in cookies"),null;console.log("\uD83D\uDD35 [AUTH-LIB] Looking up session in database");let n=await u.z.userSession.findUnique({where:{token:t},include:{user:!0}});if(!n)return console.log("\uD83D\uDD34 [AUTH-LIB] No session found in database for token"),null;if(console.log("\uD83D\uDD35 [AUTH-LIB] Session found, checking expiration"),n.expiresAt<new Date)return console.log("\uD83D\uDD34 [AUTH-LIB] Session expired, deleting"),await u.z.userSession.delete({where:{id:n.id}}),null;return console.log("\uD83D\uDFE2 [AUTH-LIB] Valid session found for user:",n.user.email),{id:n.user.id,email:n.user.email,firstName:n.user.firstName,lastName:n.user.lastName,role:n.user.role,isActive:n.user.isActive}}catch(e){return console.error("\uD83D\uDD34 [AUTH-LIB] Session error:",e),console.error("\uD83D\uDD34 [AUTH-LIB] Error stack:",e?.stack),null}}async function g(e){let t=await m();if(!t)throw Error("Authentication required");if(!t.isActive)throw Error("Account is inactive");if(e&&!e.includes(t.role))throw Error("Insufficient permissions");return t}async function v(e){try{let t=e.cookies.get("auth-token")?.value;if(!t)return null;let n=await u.z.userSession.findUnique({where:{token:t},include:{user:!0}});if(!n)return null;if(n.expiresAt<new Date)return await u.z.userSession.delete({where:{id:n.id}}),null;if(!n.user.isActive)return null;return{id:n.user.id,email:n.user.email,firstName:n.user.firstName,lastName:n.user.lastName,role:n.user.role,isActive:n.user.isActive}}catch(e){return console.error("Error getting user from token:",e),null}}},62686:(e,t,n)=>{"use strict";n.d(t,{z:()=>i});var r=n(96330);let i=globalThis.prisma??new r.PrismaClient},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67307:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[4055,534,6823,6146],()=>n(34972));module.exports=r})();