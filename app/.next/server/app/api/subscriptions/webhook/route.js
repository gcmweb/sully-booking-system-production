"use strict";(()=>{var e={};e.id=4938,e.ids=[4938],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9062:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>k,routeModule:()=>v,serverHooks:()=>P,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>I});var o={};t.r(o),t.d(o,{POST:()=>b,dynamic:()=>l});var i=t(54899),s=t(85420),n=t(22403),a=t(44917),c=t(63304),u=t(58549),d=t(96330),p=t(62686);let l="force-dynamic";async function b(e){try{let r,t=(0,c._O)();if(!t.valid)return console.error("❌ Stripe configuration errors in webhook:",t.errors),a.NextResponse.json({error:"Payment system configuration error"},{status:500});let o=await e.text(),i=e.headers.get("stripe-signature");if(!i)return console.error("❌ No Stripe signature provided"),a.NextResponse.json({error:"No signature"},{status:400});let s=process.env.STRIPE_WEBHOOK_SECRET;try{r=await (0,c.ZW)(o,i,s)}catch(e){return console.error("Webhook signature verification failed:",e),a.NextResponse.json({error:"Invalid signature"},{status:400})}switch(console.log("Received webhook event:",r.type),r.type){case"checkout.session.completed":await f(r.data.object);break;case"customer.subscription.created":await m(r.data.object);break;case"customer.subscription.updated":await S(r.data.object);break;case"customer.subscription.deleted":await h(r.data.object);break;case"invoice.payment_succeeded":await w(r.data.object);break;case"invoice.payment_failed":await y(r.data.object);break;default:console.log(`Unhandled event type: ${r.type}`)}return a.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),a.NextResponse.json({error:"Webhook handler failed"},{status:500})}}async function f(e){try{let r=e.metadata?.userId,t=e.metadata?.targetPlan;if(!r||!t)return void console.error("Missing metadata in checkout session:",e.id);console.log(`Checkout completed for user ${r}, plan: ${t}`)}catch(e){console.error("Error handling checkout completed:",e)}}async function m(e){try{let r=e.customer,t=await p.z.subscription.findFirst({where:{stripeCustomerId:r},include:{venues:{include:{owner:!0}}}});if(!t)return void console.error("No subscription found for customer:",r);let o=t.userId,i=E(e.items.data[0].price.id);await (0,u.r7)(o,i,e.id),console.log(`Subscription created for user ${o}, plan: ${i}`)}catch(e){console.error("Error handling subscription created:",e)}}async function S(e){try{let r=E(e.items.data[0].price.id),t=await p.z.subscription.findFirst({where:{stripeSubscriptionId:e.id},include:{}});if(!t)return void console.error("No subscription found for Stripe subscription:",e.id);let o=t.userId,i=d.SubscriptionStatus.ACTIVE;"canceled"===e.status?i=d.SubscriptionStatus.CANCELED:"past_due"===e.status?i=d.SubscriptionStatus.PAST_DUE:"unpaid"===e.status&&(i=d.SubscriptionStatus.INACTIVE),await p.z.subscription.update({where:{id:t.id},data:{plan:r,status:i,currentPeriodStart:new Date(1e3*e.current_period_start),currentPeriodEnd:new Date(1e3*e.current_period_end)}}),console.log(`Subscription updated for user ${o}, plan: ${r}, status: ${i}`)}catch(e){console.error("Error handling subscription updated:",e)}}async function h(e){try{let r=await p.z.subscription.findFirst({where:{stripeSubscriptionId:e.id},include:{}});if(!r)return void console.error("No subscription found for Stripe subscription:",e.id);let t=r.userId;await (0,u.r7)(t,d.SubscriptionPlan.STARTER),await p.z.subscription.update({where:{id:r.id},data:{status:d.SubscriptionStatus.CANCELED,stripeSubscriptionId:null}}),console.log(`Subscription deleted for user ${t}, downgraded to FREE`)}catch(e){console.error("Error handling subscription deleted:",e)}}async function w(e){try{let r=e.subscription;if(!r)return;let t=await p.z.subscription.findFirst({where:{stripeSubscriptionId:r}});if(!t)return void console.error("No subscription found for Stripe subscription:",r);await p.z.subscription.update({where:{id:t.id},data:{status:d.SubscriptionStatus.ACTIVE,bookingsUsed:0}}),await p.z.payment.create({data:{subscriptionId:t.id,amount:e.amount_paid/100,currency:e.currency.toUpperCase(),status:"COMPLETED",provider:"STRIPE",providerPaymentId:e.payment_intent,metadata:{invoiceId:e.id,subscriptionId:r}}}),console.log(`Payment succeeded for subscription ${r}`)}catch(e){console.error("Error handling payment succeeded:",e)}}async function y(e){try{let r=e.subscription;if(!r)return;let t=await p.z.subscription.findFirst({where:{stripeSubscriptionId:r}});if(!t)return void console.error("No subscription found for Stripe subscription:",r);await p.z.subscription.update({where:{id:t.id},data:{status:d.SubscriptionStatus.PAST_DUE}}),await p.z.payment.create({data:{subscriptionId:t.id,amount:e.amount_due/100,currency:e.currency.toUpperCase(),status:"FAILED",provider:"STRIPE",providerPaymentId:e.payment_intent,metadata:{invoiceId:e.id,subscriptionId:r,failureReason:e.last_payment_error?.message}}}),console.log(`Payment failed for subscription ${r}`)}catch(e){console.error("Error handling payment failed:",e)}}function E(e){return({[process.env.STRIPE_PAID_PRICE_ID||"price_paid_mock"]:d.SubscriptionPlan.PROFESSIONAL,[process.env.STRIPE_PREMIUM_PRICE_ID||"price_premium_mock"]:d.SubscriptionPlan.ENTERPRISE})[e]||d.SubscriptionPlan.STARTER}let v=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/subscriptions/webhook/route",pathname:"/api/subscriptions/webhook",filename:"route",bundlePath:"app/api/subscriptions/webhook/route"},resolvedPagePath:"/home/ubuntu/sully-booking-system-production/app/app/api/subscriptions/webhook/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:g,workUnitAsyncStorage:I,serverHooks:P}=v;function k(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:I})}},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},96330:e=>{e.exports=require("@prisma/client")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[4055,534,3217],()=>t(9062));module.exports=o})();