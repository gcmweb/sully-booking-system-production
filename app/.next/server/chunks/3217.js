exports.id=3217,exports.ids=[3217],exports.modules={33389:(e,t,r)=>{"use strict";r.d(t,{Dm:()=>i.Dm,M2:()=>i.M2,Yx:()=>i.Yx,fw:()=>i.fw,nV:()=>i.updateSubscription,oE:()=>i.oE});var i=r(63304)},43331:()=>{},58549:(e,t,r)=>{"use strict";r.d(t,{h:()=>n,pU:()=>c,r7:()=>a,wc:()=>u});var i=r(62686),o=r(96330),s=r(33389);async function n(e){try{let t=await i.z.venue.findMany({where:{ownerId:e},include:{subscription:!0}}),r=null,s=o.SubscriptionPlan.STARTER;for(let e of t)if(e.subscription)if(e.subscription.plan===o.SubscriptionPlan.ENTERPRISE){r=e.subscription,s=o.SubscriptionPlan.ENTERPRISE;break}else e.subscription.plan===o.SubscriptionPlan.PROFESSIONAL&&s===o.SubscriptionPlan.STARTER&&(r=e.subscription,s=o.SubscriptionPlan.PROFESSIONAL);return{subscription:r,plan:s,venues:t}}catch(e){throw console.error("Error in getUserSubscription:",e),e}}async function a(e,t,r){let{subscription:s}=await n(e);if(!s)throw Error("No subscription found for user");return await i.z.subscription.update({where:{id:s.id},data:{plan:t,stripeSubscriptionId:r||s.stripeSubscriptionId,bookingsLimit:t===o.SubscriptionPlan.STARTER?50:null,updatedAt:new Date}})}async function c(e){let{subscription:t}=await n(e);if(!t)throw Error("No subscription found for user");return await i.z.subscription.update({where:{id:t.id},data:{status:o.SubscriptionStatus.CANCELED,updatedAt:new Date}})}async function u(e,t,r){let{subscription:o}=await n(e);if(o?.stripeCustomerId)return o.stripeCustomerId;let a=await (0,s.Yx)(t,r);return o&&await i.z.subscription.update({where:{id:o.id},data:{stripeCustomerId:a.id}}),a.id}},62686:(e,t,r)=>{"use strict";r.d(t,{z:()=>o});var i=r(96330);let o=globalThis.prisma??new i.PrismaClient},63304:(e,t,r)=>{"use strict";let i;r.d(t,{Dm:()=>a,M2:()=>m,UN:()=>S,Yx:()=>u,ZW:()=>_,_O:()=>n,f:()=>p,fw:()=>d,oE:()=>l,updateSubscription:()=>E}),function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}();try{let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY environment variable is required");e.startsWith("sk_test_")&&"test"!==process.env.STRIPE_MODE&&console.warn("⚠️  WARNING: Using test Stripe keys in production environment"),i=Object(function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}())(e,{apiVersion:"2025-05-28.basil",typescript:!0,telemetry:!1})}catch(e){throw console.error("❌ Failed to initialize Stripe:",e),e}let o=()=>{let e=process.env.STRIPE_SECRET_KEY,t=process.env.STRIPE_MODE;return"live"===t||"test"!==t&&(e?.startsWith("sk_live_")||!1)},s=()=>{let e=process.env.STRIPE_SECRET_KEY;return!e||"sk_test_mock_key"===e||"sk_test_mock_key_for_demo"===e||e.includes("mock")},n=()=>{let e=[];return process.env.STRIPE_SECRET_KEY||e.push("STRIPE_SECRET_KEY is required"),process.env.STRIPE_PUBLISHABLE_KEY||e.push("STRIPE_PUBLISHABLE_KEY is required"),process.env.STRIPE_WEBHOOK_SECRET||e.push("STRIPE_WEBHOOK_SECRET is required for webhook security"),o()||s()||(process.env.STRIPE_PAID_PRICE_ID||e.push("STRIPE_PAID_PRICE_ID is required"),process.env.STRIPE_PREMIUM_PRICE_ID||e.push("STRIPE_PREMIUM_PRICE_ID is required")),{valid:0===e.length,errors:e}},a={PAID:process.env.STRIPE_PAID_PRICE_ID||(s()?"price_paid_mock":void 0),PREMIUM:process.env.STRIPE_PREMIUM_PRICE_ID||(s()?"price_premium_mock":void 0)};async function c(e,t){try{return await e()}catch(e){if(console.error(`Stripe Error - ${t}:`,e),e instanceof Object(function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}()).StripeError)switch(console.error("Stripe Error Details:",{type:e.type,code:e.code,message:e.message,statusCode:e.statusCode}),e.type){case"StripeCardError":throw Error("Your card was declined. Please try a different payment method.");case"StripeRateLimitError":throw Error("Too many requests. Please try again in a moment.");case"StripeInvalidRequestError":throw Error("Invalid request. Please contact support if this continues.");case"StripeAPIError":throw Error("Payment service temporarily unavailable. Please try again.");case"StripeConnectionError":throw Error("Network error. Please check your connection and try again.");case"StripeAuthenticationError":throw Error("Authentication failed. Please contact support.");default:throw Error("Payment processing failed. Please try again or contact support.")}throw Error(t)}}async function u(e,t,r){return s()?{id:`cus_demo_${Date.now()}`,email:e,name:t,metadata:{source:"sully_booking_system",demo:"true",...r},object:"customer",balance:0,created:Math.floor(Date.now()/1e3),default_source:null,delinquent:!1,description:null,discount:null,invoice_prefix:null,invoice_settings:{custom_fields:null,default_payment_method:null,footer:null,rendering_options:null},livemode:!1,next_invoice_sequence:1,phone:null,preferred_locales:[],shipping:null,tax_exempt:"none",test_clock:null}:c(async()=>await i.customers.create({email:e,name:t,metadata:{source:"sully_booking_system",created_at:new Date().toISOString(),...r}}),"Failed to create customer")}async function d(e,t,r,o,n){if(s()){let i=`cs_demo_${Date.now()}`;return{id:i,url:`${r}?session_id=${i}&demo=true&price_id=${t}`,customer:e,metadata:n||{},mode:"subscription",success_url:r,cancel_url:o}}return c(async()=>await i.checkout.sessions.create({customer:e,payment_method_types:["card"],line_items:[{price:t,quantity:1}],mode:"subscription",success_url:r,cancel_url:o,allow_promotion_codes:!0,billing_address_collection:"auto",customer_update:{name:"auto",address:"auto"},metadata:{created_at:new Date().toISOString(),...n},subscription_data:{metadata:n||{}}}),"Failed to create checkout session")}async function l(e,t){return s()?{id:`bps_demo_${Date.now()}`,url:`${t}?billing_portal=demo&customer=${e}`,customer:e,return_url:t}:c(async()=>await i.billingPortal.sessions.create({customer:e,return_url:t,flow_data:{type:"subscription_update_confirm",subscription_update_confirm:{subscription:e,items:[]}}}),"Failed to create billing portal session")}async function p(e,t="gbp",r){return s()?{id:`pi_demo_${Date.now()}`,client_secret:`pi_demo_${Date.now()}_secret_${Math.random().toString(36).substr(2,9)}`,amount:Math.round(100*e),currency:t,status:"requires_payment_method",metadata:r||{}}:c(async()=>await i.paymentIntents.create({amount:Math.round(100*e),currency:t.toLowerCase(),automatic_payment_methods:{enabled:!0},metadata:{created_at:new Date().toISOString(),...r}}),"Failed to create payment intent")}async function _(e,t,r){let o=r||process.env.STRIPE_WEBHOOK_SECRET;if(!o)throw Error("Webhook secret is required for security");if(s())try{return JSON.parse(e)}catch(e){throw Error("Invalid webhook payload")}return c(async()=>i.webhooks.constructEvent(e,t,o),"Invalid webhook signature")}async function E(e,t){return s()?{id:e,customer:"cus_demo",status:"active",items:{data:[{id:`si_demo_${Date.now()}`,price:{id:t}}]}}:c(async()=>{let r=await i.subscriptions.retrieve(e);return await i.subscriptions.update(e,{items:[{id:r.items.data[0].id,price:t}],proration_behavior:"create_prorations"})},"Failed to update subscription")}async function m(e){return s()?{id:e,status:"canceled",cancel_at_period_end:!0}:c(async()=>await i.subscriptions.update(e,{cancel_at_period_end:!0}),"Failed to cancel subscription")}function S(){return{isLiveMode:o(),isDemoMode:s(),publishableKey:process.env.STRIPE_PUBLISHABLE_KEY,priceIds:a,validation:n()}}a.PAID,a.PREMIUM},67307:()=>{}};