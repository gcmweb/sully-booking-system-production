(()=>{var e={};e.id=1199,e.ids=[1199],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},43331:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},62686:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});var a=r(96330);let n=globalThis.prisma??new a.PrismaClient},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67307:()=>{},88482:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>y,serverHooks:()=>w,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{POST:()=>c,dynamic:()=>u});var n=r(54899),o=r(85420),s=r(22403),i=r(44917),d=r(62686),p=r(96330);let u="force-dynamic";async function c(e){try{let t=await e.text();e.headers.get("stripe-signature");let r=JSON.parse(t);switch(r.type){case"payment_intent.succeeded":await l(r.data.object);break;case"payment_intent.payment_failed":await m(r.data.object);break;default:console.log(`Unhandled event type: ${r.type}`)}return i.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),i.NextResponse.json({error:"Webhook handler failed"},{status:400})}}async function l(e){try{let t=await d.z.payment.findFirst({where:{providerPaymentId:e.id},include:{booking:{include:{venue:!0}}}});if(!t)return void console.error("Payment not found for payment intent:",e.id);await d.z.payment.update({where:{id:t.id},data:{status:p.PaymentStatus.COMPLETED,metadata:{...t.metadata||{},paymentIntentStatus:e.status,completedAt:new Date().toISOString()}}}),await d.z.booking.update({where:{id:t.bookingId},data:{isPaid:!0,status:"CONFIRMED"}}),console.log(`Payment succeeded for booking ${t.bookingId}`)}catch(e){console.error("Error handling payment succeeded:",e)}}async function m(e){try{let t=await d.z.payment.findFirst({where:{providerPaymentId:e.id}});if(!t)return void console.error("Payment not found for payment intent:",e.id);await d.z.payment.update({where:{id:t.id},data:{status:p.PaymentStatus.FAILED,metadata:{...t.metadata||{},paymentIntentStatus:e.status,failedAt:new Date().toISOString(),failureReason:e.last_payment_error?.message}}}),console.log(`Payment failed for booking ${t.bookingId}`)}catch(e){console.error("Error handling payment failed:",e)}}let y=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/payments/stripe/webhook/route",pathname:"/api/payments/stripe/webhook",filename:"route",bundlePath:"app/api/payments/stripe/webhook/route"},resolvedPagePath:"/home/ubuntu/sully-booking-system-production/app/app/api/payments/stripe/webhook/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:h,workUnitAsyncStorage:g,serverHooks:w}=y;function f(){return(0,s.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:g})}},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4055,534],()=>r(88482));module.exports=a})();