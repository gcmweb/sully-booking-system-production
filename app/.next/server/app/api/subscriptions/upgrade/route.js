"use strict";(()=>{var e={};e.id=1949,e.ids=[1949],e.modules={3184:(e,r,s)=>{s.r(r),s.d(r,{patchFetch:()=>h,routeModule:()=>g,serverHooks:()=>w,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>x});var t={};s.r(t),s.d(t,{POST:()=>f,dynamic:()=>d});var n=s(54899),i=s(85420),o=s(22403),u=s(44917),a=s(62258),l=s(96330),c=s(58549),p=s(33389);let d="force-dynamic";async function f(e){try{let r=await (0,a.l4)(e);if(!r)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{plan:s,returnUrl:t}=await e.json();if(!s||!Object.values(l.SubscriptionPlan).includes(s))return u.NextResponse.json({error:"Invalid plan"},{status:400});if(s===l.SubscriptionPlan.STARTER)return u.NextResponse.json({error:"Cannot upgrade to FREE plan"},{status:400});let{subscription:n}=await (0,c.h)(r.id),i=await (0,c.wc)(r.id,r.email,`${r.firstName} ${r.lastName}`),o=p.Dm[s];if(!o)return u.NextResponse.json({error:"Invalid subscription plan"},{status:400});let d=new URL(e.url).origin,f=t||`${d}/dashboard/subscription?success=true`,g=t||`${d}/dashboard/subscription?canceled=true`;if(n?.stripeSubscriptionId)try{let e=await (0,p.nV)(n.stripeSubscriptionId,o);return await (0,c.r7)(r.id,s,e.id),u.NextResponse.json({success:!0,message:"Subscription updated successfully",subscription:e})}catch(e){console.error("Error updating existing subscription:",e)}let m=await (0,p.fw)(i,o,f,g,{userId:r.id,targetPlan:s});return u.NextResponse.json({checkoutUrl:m.url,sessionId:m.id})}catch(e){return console.error("Upgrade subscription error:",e),u.NextResponse.json({error:"Failed to upgrade subscription"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/subscriptions/upgrade/route",pathname:"/api/subscriptions/upgrade",filename:"route",bundlePath:"app/api/subscriptions/upgrade/route"},resolvedPagePath:"/home/ubuntu/sully-booking-system-production/app/app/api/subscriptions/upgrade/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:m,workUnitAsyncStorage:x,serverHooks:w}=g;function h(){return(0,o.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:x})}},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},62258:(e,r,s)=>{s.d(r,{BE:()=>p,Er:()=>c,Ht:()=>f,jw:()=>d,l4:()=>m,oC:()=>g});var t=s(29657),n=s.n(t),i=s(3197),o=s.n(i),u=s(24883),a=s(62686);let l=process.env.JWT_SECRET||"sully-booking-system-secret-key";async function c(e){return n().hash(e,12)}async function p(e,r){return n().compare(e,r)}async function d(e){var r;let s=(r={userId:e},o().sign(r,l,{expiresIn:"7d"})),t=new Date;return t.setDate(t.getDate()+7),await a.z.userSession.create({data:{userId:e,token:s,expiresAt:t}}),s}async function f(){console.log("\uD83D\uDD35 [AUTH-LIB] Getting session");try{let e=(0,u.UL)(),r=e.get("auth-token")?.value;if(console.log("\uD83D\uDD35 [AUTH-LIB] Token from cookies:",r?`Token found (${r.substring(0,20)}...)`:"No token found"),!r)return console.log("\uD83D\uDD35 [AUTH-LIB] No auth token found in cookies"),null;console.log("\uD83D\uDD35 [AUTH-LIB] Looking up session in database");let s=await a.z.userSession.findUnique({where:{token:r},include:{user:!0}});if(!s)return console.log("\uD83D\uDD34 [AUTH-LIB] No session found in database for token"),null;if(console.log("\uD83D\uDD35 [AUTH-LIB] Session found, checking expiration"),s.expiresAt<new Date)return console.log("\uD83D\uDD34 [AUTH-LIB] Session expired, deleting"),await a.z.userSession.delete({where:{id:s.id}}),null;return console.log("\uD83D\uDFE2 [AUTH-LIB] Valid session found for user:",s.user.email),{id:s.user.id,email:s.user.email,firstName:s.user.firstName,lastName:s.user.lastName,role:s.user.role,isActive:s.user.isActive}}catch(e){return console.error("\uD83D\uDD34 [AUTH-LIB] Session error:",e),console.error("\uD83D\uDD34 [AUTH-LIB] Error stack:",e?.stack),null}}async function g(e){let r=await f();if(!r)throw Error("Authentication required");if(!r.isActive)throw Error("Account is inactive");if(e&&!e.includes(r.role))throw Error("Insufficient permissions");return r}async function m(e){try{let r=e.cookies.get("auth-token")?.value;if(!r)return null;let s=await a.z.userSession.findUnique({where:{token:r},include:{user:!0}});if(!s)return null;if(s.expiresAt<new Date)return await a.z.userSession.delete({where:{id:s.id}}),null;if(!s.user.isActive)return null;return{id:s.user.id,email:s.user.email,firstName:s.user.firstName,lastName:s.user.lastName,role:s.user.role,isActive:s.user.isActive}}catch(e){return console.error("Error getting user from token:",e),null}}},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{e.exports=require("buffer")},96330:e=>{e.exports=require("@prisma/client")}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[4055,534,6823,3217],()=>s(3184));module.exports=t})();